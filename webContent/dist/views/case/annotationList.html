<!--
 * @Author: cwx
 * @Description: 选择报告用图
 * @Date: 2022-05-31 17:40:21
 * @LastEditTime: 2022-06-02 15:51:23
 * @FilePath: \ReportSystem_Demo\webContent\dist\views\case\annotationList.html
-->

<meta name="referrer" content="no-referrer">

<div class="layui-fluid">
    <div class="layui-row layui-col-space15">
        <div class="layui-card">
            <div class="layui-card-header">标注列表</div>
            <div class="layui-card-body">
                <table class="layui-show" id="annotation-table" lay-filter="annotation-table"></table>
                <div class="layui-btn-container case-table-btn" style="margin-top: 20px;">
                    <!-- <a href="./#/case/caseForm" class="layui-btn layui-btn-sm" target="_self">新建病例</a> -->
                    <button class="layui-btn layui-btn-sm" data-type="submit">提交</button>
                </div>
            </div>
        </div>
    </div>
</div>
<style type="text/css">
    .laytable-cell-checkbox {
        height: auto;
    }

    .layui-table-cell {
        text-align: center;
        height: auto;
        white-space: normal;
    }

    .layui-table img {
        max-width: 200px
    }
</style>

<script type="text/html" template lay-done="layui.data.sendParams(d.params)"></script>
<!-- 定义一个 lay-done 对应的全局方法，以供动态模板执行 -->
<script>
    layui.data.sendParams = function (params) {
        layui.define(['admin', 'form', 'laydate', 'table', 'laytpl'], function () {
            var $ = layui.$,
                admin = layui.admin,
                element = layui.element,
                layer = layui.layer,
                laydate = layui.laydate,
                table = layui.table,
                laytpl = layui.laytpl,
                form = layui.form;
            setter = layui.setter;

            table.render({
                elem: '#annotation-table',
                url: 'api/slideCenter/annotationTable', //使用后端数据
                response: {
                    statusCode: 200
                },
                where: {
                    data: params.path
                },
                cols: [
                    [{
                            field: 'checkbox',
                            type: 'checkbox',
                        },
                        {
                            field: 'slideUrl',
                            title: '标注图',
                            templet: function (d) {
                                return `<div><img src="${d.slideUrl}" width="80" height="80"></div>`
                            },
                            minWidth: 120
                        }, {
                            field: 'comments',
                            title: '描述',
                            minWidth: 120
                        }
                    ]
                ],
                page: true,
                limit: 20,
            });

            /* 监听提交 */
            form.on('submit(query)', function (data) {
                table.reload('expert-table', {
                    where: data.field,
                    url: 'api/user/queryExpert',
                    method: 'POST',
                    data: JSON.stringify({
                        data: data.field,
                    }),
                    contentType: 'application/json;charset=UTF-8',
                })
                return false;
            });

            // 按钮监听
            $('.case-table-btn .layui-btn').on('click', function () {
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });
            var active = {
                submit: function () {
                    var checkStatus = table.checkStatus('expert-table'),
                        checkData = checkStatus.data;
                    if (checkData === undefined) {
                        return layer.msg('请选择专家');
                    } else {
                        admin.req({
                            url: 'api/case/chooseExpert',
                            type: 'POST',
                            contentType: 'application/json;charset=UTF-8',
                            data: JSON.stringify({
                                data: checkData,
                                caseID: params.caseData.id
                            }),
                            success: function (res) {
                                location.href = './#/case/caseUpload'; // 跳转回列表
                            },
                            done: function (res) {
                                layui.table.reload('case-table');
                                layer.msg('选择专家成功,请关闭窗口');
                            }
                        })
                    }
                },
            }

        });
    };
</script>